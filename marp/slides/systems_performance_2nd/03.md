---
marp: true
theme: custom_title_pos
paginate: true
---

<!--
headingDivider: 2
-->


<!-- _class: title -->

# Systems Performance, 2nd Edition

Chapter 3. Operating Systems (3.2.10 - )

_2022-08-22_
_Kohei Sakai_

## ToC

## 3.2.10 File Systems

ファイルシステムのことは知っていると信じるが

* ファイルに対して、POSIX 標準に基づいてアクセスするためのインターフェイスをOSが提供
* ファイルと、それをまとめるディレクトリが、`/` から始まるツリー構造で編成されている
* `mount` という操作によって、独自のツリーをマウントポイントにアタッチできる
    * ファイルシステムタイプに依存せずに、ツリーをたどることでアクセスできる

多くのファイルシステムはストレージデバイスを使ったものだが、 `/proc` `/dev` などはkernelが動的に生成する。
kernelはchroot(8)やmount namespaceなど、プロセスごとにファイルシステム名前空間を分離する方法を提供する。

※そういえば chroot(8)の(8)って何を意味しているか知ってるか聞いてみる

---

### VFS

VFS = _virtual file system_
新しいファイルシステムタイプを追加するときに、便利な仕組み。
[Overview of the Linux Virtual File System](https://www.kernel.org/doc/html/latest/filesystems/vfs.html)

![vsf.jpg](./ch03/vfs.jpg)
Figure 3.14 Virtual file system

---

### I/O Stack

ストレージデバイスベースのファイルシステムでの、ユーザーレベルのストレージアクセス。
ファイルシステムを介さない、ブロックデバイスの直接のパスは、DBなどで利用されることがある。

![w:550](./ch03/generic_io_stack.jpg)
Figure 3.15 Generic I/O stack

## 3.2.11 Caching

[このテーブル](https://learning.oreilly.com/library/view/systems-performance-2nd/9780136821694/ch03.xhtml#ch03tab02)にある通り、いろんなキャッシュがある。

## 3.2.12 Networking

詳細はChapter 10。

カーネルは、ビルトインのネットワークプロトコルを内蔵したスタックを提供している。
一般的に利用されるTCP/IPプロトコルにちなんでTCP/IPスタックとも呼ばれ、ユーザーレベルのアプリケーションは、ソケットを介してネットワークにアクセスする。

QUIC(Ref. Chapter 10)のサポートといった、新しいプロトコルや拡張、オプションなどはカーネルのサポートを必要とする。(ユーザースペースで実装するときは、もちろん違う)
また、新しいNICのサポートは、新しいデバイスドライバが必要になる。

## 3.2.13 Device Drivers

ドライバ=デバイスの管理と入出力を行うためのカーネルソフトウェア

デバイスドライバは2種類のインターフェースを提供できる。

* Character Interface: 任意のI/Oサイズのバッファなしシーケンシャルアクセスを提供
    * キーボード、シリアルポートなど
* Block Interface: あるブロック(歴史的に512byteごと)単位でI/Oを実行する。ブロックオフセットに基づいて、ランダムアクセスできる
    * 性能向上のために、Linuxではバッファキャッシュを提供している

## 3.2.14 Multiprocessor


アーキテクチャとして大きく2つある。この本で話されている気がするので割愛。 [間違ってたとき用のリンク](https://www.itmedia.co.jp/news/articles/2208/04/news099.html)

詳細は Chapter 6: CPUsや、Chapter 7: Memoryで話される。

* SMP(_Symmetric Multiprocessing_)
* NUMA(_Non-Uniform Memory Access_)


---

### IPI

IPI=_inter-processor interrupt_

マルチプロセッサシステムでは、キャッシュコヒーレンシなどCPU間の連携が必要な場合がある。
IPIは次で説明するpreemptionでも使う。

## 3.2.15 Preemption
