---
marp: true
theme: custom
paginate: true
---

<!--
headingDivider: 2
-->


<!-- _class: title -->

# Optimizing Java

Chapter 4. Performance Testing Patterns and Antipatterns

_2021-06-13_
_Kohei Sakai_

## ToC

この章で理解できること

1. パフォーマンステストのタイプとそのベストプラクティス
2. パフォーマンステストのアンチパターン

## パフォーマンステストの種類

パフォーマンステストは、間違った理由で頻繁に実行されていて、注意が必要。
* パフォーマンス分析の性質の無理解
* 何もないよりやったほうが良いという信念

**パフォーマンステストを計画する際の目安**
1. 定量的な質問
2. 合意された、その質問が重要である理由

## 一般的なパフォーマンステスト

* Latency test: E2Eのトランザクションタイムがどの程度か?
* Throughput test: 現在のシステム容量はいくつの同時トランザクションを処理できるか?
* Load test: システムが特定の負荷を処理できるか?
* Stress test: システムの限界点は何か?
* Endurance test: システムを長時間実行すると、どんなパフォーマンス以上が発見されるか?
* Capacity planning test: リソースを追加したとき、期待通りに拡張されるか?
* Degradation: システムに部分的な障害が発生したらどうなるか?
    * Chaos Monkey

## Best Practice Primer

パフォーマンスチューニングを行う際にどこに注力すべきかを決める**3つのルール**
1. 注目することを特定し、それを測定する方法を見つける
2. (最適化が容易なものではなくて、)重要なものを最適化する
3. 最初に重要なポイントから取り組む

※簡単に測定できる量に過剰に意味を持たせないように注意すること。

---

### Top-Down Performance

コードの断片の正確なベンチマーク数値を取るよりも、大規模なベンチマークを取ることが簡単。 (Chapter 5)

###  Creating a Test Environments

可能な限り、これはすべての面で本番環境の正確な複製である必要がある。

### Identifying Performance Requirements

パフォーマンス評価のメトリックは、コードの観点からのみ考えるべきではない。
コンテナ、オペレーティングシステム、ハードウェアなどシステム全体と、顧客や管理者に重要な観測可能なメトリクスで決める。(NFR: パフォーマンス非機能要件)

---

### Java-Specific Issues

JVMの性質から来る問題があり、Java固有の洞察が必要。
JITコンパイルも重要なもので、例えば、ある重要なコードパスのメソッドがJITコンパイルされているかどうかを確認する必要がある。JITコンパイルされていないとすれば、
1. コンパイルを保証するほど頻繁に実行されていない
2. メソッドが大きすぎるか、複雑すぎるため、コンパイルのために分析されない

詳細はChapter 9で。

### Performance Testing as Part of the SDLC(Software Development Lifecycle)

1回限りでパフォーマンステストを行わずに、継続的に実施しよう。
特にパフォーマンスのリグレッションテストをしよう。

## パフォーマンスアンチパターンの紹介

CareyFlichelによる「[開発者が悪いテクノロジーの選択を続ける理由](https://web.obsidianscheduler.com/why-developers-keep-making-bad-technology-choices/)」というブログ投稿

---

### 退屈

既存もので十分なのに、不必要に複雑なコードを書いたり、未知のテクノロジーや、おそらくユースケースに適合しないテクノロジーを使用してコンポーネントを構築する

### 履歴書パディング

転職に有利になりそうな、特定のテクノロジーを利用しようとする。

### 仲間からの圧力

技術的な選択が行われているときに懸念が表明または議論されていない場合がある。
理由は色々。経験不足によるミスを恐れたり、未知のものだったり、細かい調査をした場合に開発速度が落ちることだったり。

---

### 理解の欠如

開発者がプラットフォームで実際にどのように機能しているかを理解していないか、知りたくないために、テクノロジーが選択されることがある。

> 例えば、パフォーマンスの高いリレーショナルデータベースの経験がない場合は、拡張性のないものを実装する可能性があることを恐れて、NoSQLルートを使用する傾向があります。しかし、多くの場合、この恐れは根拠がない可能性があります。

### 誤解されている/存在しない問題

問題領域自体が十分に調査されていない特定の問題を解決するためにテクノロジーを使用することがよくある。
> 開発者が新しいテクノロジーを売り込むときの共通のテーマは、XとYを実行し、Zから保護することです。しかし、多くの場合、X、Y、Zはそもそも問題ではありませんでした。

## アンチパターンを防ぐには?

* 要件（一貫性、フェイルオーバー、パフォーマンスなど）を確認
* あなたが持っているものがニーズをうまく満たすことができるかどうかを評価。もしそうなら、これはほとんど常に正しい選択
* 他のテクノロジーがどのようにニーズを満たすかを調査し、追加の依存関係と潜在的な障害ポイントのコストを考慮に入れる
* チームの専門知識を見つける–あなたがよく知っていることを支持する
* 価格設定、タイムラインなどの他の懸念事項を考慮に入れる
* チームと話し合い、賛否両論のリストを作成する

## パフォーマンスアンチパターンカタログ

このスライドでは、各項目の説明を中心にする。
解決方法などは書籍を参照。

---

### Distracted by Shiny

レガシーなコードを掘り下げることを避けて、新しい技術やテクノロジーの部分からチューニングしようとする

(いまいちResolutionがよくわかっていないが、新しい技術に適合するように進めるのが良いと言っているように見える)

---

### Distracted by Simple

アプリケーション全体をプロファイリングして、その中の問題点を客観的に探すのではなく、自分たちが理解している部分だけを対象とする。
特定の箇所を特定のメンバーしか理解できていない。

---

### Performance Tuning Wizard

1人の天才を雇用して対応する。

このパターンは、パフォーマンスの問題に対処するのに十分ではないと感じているチームの開発者を遠ざける可能性がある。多くの場合、少量のプロファイラーガイドによる最適化がパフォーマンスの向上につながる可能性がある。

---

### Tuning by Folklore

"マジック"設定パラメータをウェブで探すことに必死になる

---

### The Blame Donkey

分析もせずに、特定のコンポーネントの問題だと決め付ける

---

### Missing the Bigger Picture

全体像を把握せずに、アプリケーションの特定の部分のプロファイリングやチューニングに夢中になる。

---

### UAT Is My Desktop

本番環境と異なる環境でテストする

---

### Production-Like Data Is Hard

本番環境と同等のデータを用意することは難しい

(実際難しいのでは?)

## 認知バイアスとパフォーマンステスト

---

### 還元主義的思考

システムの各部分を理解したからといって、全体を理解できすとは限らない。

### 確証バイアス

[Wikipedia](https://ja.wikipedia.org/wiki/%E7%A2%BA%E8%A8%BC%E3%83%90%E3%82%A4%E3%82%A2%E3%82%B9)
> 確証バイアス（かくしょうバイアス、英: confirmation bias）とは、認知心理学や社会心理学における用語で、仮説や信念を検証する際にそれを支持する情報ばかりを集め、反証する情報を無視または集めようとしない傾向のこと

新しい技術を採用するとき、本番とは異なるデータに対してローカルでテストして良い結果を得ただけで、求めているものだと判断してしまう。

---

### 戦場の霧（行動バイアス）

[Wikipedia](https://ja.wikipedia.org/wiki/%E6%88%A6%E5%A0%B4%E3%81%AE%E9%9C%A7)
> 戦場の霧（せんじょうのきり、独: Nebel des Krieges、英: fog of war）は、作戦・戦闘における指揮官から見た不確定要素を言う。

行動バイアス: 行動が先入観や思い込みにより影響を受ける。 ( [参考1](https://japan.pimco.com/ja-jp/book-biases), [参考2](https://award-finance.com/investment/1445/), [参考3](https://www-hs.yamagata-u.ac.jp/wp-content/uploads/2020/09/7d8b374292f3858b036e0ba4a9b1e672-1.pdf) )
* 損失回避バイアス
* 現状維持バイアス

---

### リスクバイアス

[Wikipedia](https://en.wikipedia.org/wiki/Zero-risk_bias)
> Zero-risk bias is a tendency to prefer the complete elimination of a risk in a sub-part even when alternative options produce a greater overall reduction in risk.

小さいリスクを取って製品を良くできるとしても、積極的には実施したくならない。

### エルズバーグのパラドックス

[Wikipedia](https://ja.wikipedia.org/wiki/%E6%9B%96%E6%98%A7%E3%81%95%E5%9B%9E%E9%81%BF_(%E7%B5%8C%E6%B8%88%E5%AD%A6)#%E3%82%A8%E3%83%AB%E3%82%BA%E3%83%90%E3%83%BC%E3%82%B0%E3%81%AE%E3%83%91%E3%83%A9%E3%83%89%E3%83%83%E3%82%AF%E3%82%B9), [参考](https://glossary.mizuho-sc.com/faq/show/1863?site_domain=default)
曖昧さを回避する選好があるらしい。[期待効用理論の公理](https://glossary.mizuho-sc.com/faq/show/1855?back=front%2Fcategory%3Ashow&category_id=87&page=2&site_domain=default&sort=sort_adjust_value&sort_order=desc)の独立性っていうやつの反例らしい。

## サマリー

パフォーマンス結果を評価するときは、データを適切な方法で処理し、非科学的で主観的な思考に陥らないようにすることが不可欠。
バイアスを認識しておこう。